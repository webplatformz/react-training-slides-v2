<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>07 Data Fetching | Essential React</title>

    <link rel="icon" href="../img/zuehlke_logo.jpg" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/webplatformz/zuehlke-reveal-package@aa0782bae9e270f4153d310e9f42bea172788e21/release/index.css"
    />
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        <section class="deck-slide">
          <h1>
            Essential React <br />
            07 Data Fetching
          </h1>
        </section>
        <section>
          <section>
            <p><img src="../img/data_fetching_goal.png" /></p>
            <p class="fragment">Where do we get this data from?</p>
          </section>
          <section>
            <h2>PokeAPI</h2>
            <a
              href="https://pokeapi.co/"
              target="_blank"
              rel="noopener noreferrer"
            >
              Documentation
            </a>
          </section>
          <section>
            <h3>List of Pokemon</h3>
            <pre><code class="hljs json" data-trim data-line-numbers="5-13"><script type="text/template">
                {
                  "count": 1118,
                  "next": "https://pokeapi.co/api/v2/pokemon?offset=5&limit=5",
                  "previous": null,
                  "results": [
                    {
                      "name": "bulbasaur",
                      "url": "https://pokeapi.co/api/v2/pokemon/1/"
                    },
                    {
                      "name": "ivysaur",
                      "url":"https://pokeapi.co/api/v2/pokemon/2/"
                    },
                    â€¦
                  ]
                }
              </script></code></pre>
            <p>
              <a
                href="https://pokeapi.co/api/v2/pokemon?limit=5"
                target="_blank"
                rel="noopener noreferrer"
              >
                GET https://pokeapi.co/api/v2/pokemon?limit=5
              </a>
            </p>
          </section>
        </section>
        <section>
          <section><h2>What to use for data fetching?</h2></section>
          <section>
            <ul>
              <li>React does <em>not</em> provide data fetching</li>
              <li><span class="warn">Fetch:</span> standard browser API</li>
              <li>&hellip; or any data fetching library</li>
            </ul>

            <aside class="notes">
              <p>
                We will demonstrate here a very basic way to perform data
                fetching. It works and might be fine for very small
                applications.
              </p>

              <p>
                With React 18: Suspense for data fetching. Should be used with a
                library.
              </p>
            </aside>
          </section>
          <section>
            <h3>Fetch</h3>
            <pre><code class="hljs typescript" data-trim data-line-numbers="1-4|6-9|11-12|"><script type="text/template">
                /* Send the request and wait for the response */
                const response = await fetch(
                  'https://example.com/data'
                );

                /* Did we get a response status code other than 2XX? */
                if (!response.ok) {
                  throw new Error("Could not fetch data!");
                }

                /* Deserialize the JSON response body */
                const data = await response.json();
              </script></code></pre>
          </section>
        </section>
        <section>
          <section>
            <h2>How <em>can</em> we use fetch in React?</h2>
          </section>
          <section>
            <p>Does this work?</p>
            <pre><code class="hljs tsx" data-trim data-line-numbers="|2,5"><script type="text/template">
               function MyComponent() {
                 const response = await fetch('/user');
                 if (!response.ok) throw new Error('Could not fetch data!');   

                 const user = await response.json();   
                 
                 return <p>{user.name}</p>;
               }        
              </script></code></pre>
            <p class="fragment">
              <span class="warn">Does not work!</span> &ndash; The render
              function is not async.
            </p>
          </section>
          <section>
            <p>Well, how about this?</p>
            <pre><code class="hljs tsx" data-trim data-line-numbers="|4,7|2,8,12"><script type="text/template">
               function MyComponent() {
                 let user;

                 fetch('/user').then(response => {
                   if (!response.ok) throw new Error('Could not fetch data!');

                   response.json().then(u => {
                     user = u;
                   });
                 });   
                 
                 return <p>{user?.name}</p>;
               }</script></code></pre>
            <p class="fragment">
              <span class="warn">Does not work!</span> &ndash; When the promise
              resolves, the render function already ran.
            </p>
          </section>
          <section>
            <p>Fetching data asynchronously requires state management.</p>
            <p><span class="warn">&rarr;useState</span></p>
          </section>
          <section>
            <pre><code class="hljs tsx" data-trim data-line-numbers="|4,7|2,8,12"><script type="text/template">
              function MyComponent() {
                const [user, setUser] = useState();

                fetch('/user').then(response => {
                  if (!response.ok) throw new Error('Could not fetch data!');

                  response.json().then(u => {
                    setUser(u);
                  });
                });   
                
                return <p>{user?.name}</p>;
              }</script></code></pre>
            <p class="fragment">
              <span class="warn">Bad!</span> &ndash; This produces an infinte
              loop.
            </p>
          </section>
          <section>
            <h3>
              Why we should <em>not</em> run side effects in the render function
            </h3>
            <ul>
              <li class="fragment">
                We don't want the side effect to execute with every render.
              </li>
              <li class="fragment">
                The render function might be executed anytime &ndash; we don't
                control it.
              </li>
              <li class="fragment">
                In the render function we just want to render and not spend
                computing on other tasks.
              </li>
            </ul>
          </section>

          <section data-auto-animate>
            <p>Handle side effects with <span class="warn">useEffect</span></p>

            <pre
              data-id="code2"
            ><code class="hljs tsx" data-trim data-line-numbers="4,5,11,12|"><script type="text/template">
              function MyComponent() {
                const [user, setUser] = useState();

                useEffect(() => {
                  (async function() {
                    const response = await fetch('/user');
                    if (!response.ok) throw new Error('Could not fetch data!');
  
                    const user = await response.json();
                    setUser(user);
                  })();
                }, []);
                
                return <p>{user?.name}</p>;
              }
            </script></code></pre>

            <p><span class="warn">This works!</span>, but ...</p>
          </section>
        </section>
        <section>
          <section>
            <img
              src="../img/user-duplicate-request.png"
              alt="Duplicate request"
            />

            <p>What's going on here?</p>
          </section>
          <section data-auto-animate>
            <p><span class="code">index.tsx</span></p>
            <pre
              data-id="code"
            ><code class="hljs tsx" data-trim data-line-numbers="5,7"><script type="text/template">
            const root = ReactDOM.createRoot(
              document.getElementById("root") as HTMLElement
            );
            root.render(
              <React.StrictMode>
                <App />
              </React.StrictMode>
            );
</script></code></pre>
            <p>
              In development, when using <em>Strict Mode</em>, components are
              re-mounted: mount, unmount, mount
            </p>
            <p>Purpose: <span class="warn">future-proofing</span> the app</p>
          </section>
          <section data-auto-animate>
            <p>
              In development, when using <em>Strict Mode</em>, components are
              re-mounted: mount, unmount, mount
            </p>
            <p>Purpose: <span class="warn">future-proofing</span> the app</p>
            <p>
              &rarr; Effects are executed at least twice in development<br /><small
                >(not in prod)</small
              >
            </p>
            <p>
              Therefore it is recommanded to not fetch data with useEffect but
              rely on a library, so let's do it!
            </p>
          </section>
          <section data-auto-animate>
            <p>Configure TanStack Query</p>
            <p>
              <span class="code">npm i @tanstack/react-query</span>
            </p>
            <pre
              data-id="code2"
            ><code class="hljs tsx" data-trim data-line-numbers="1|6-8"><script type="text/template">
              const queryClient = new QueryClient();

              function App() {
                /* Provide the client to your App */
                return (
                  <QueryClientProvider client={queryClient}>
                    <MyComponent />
                  </QueryClientProvider>
                );
              }
            </script></code></pre>
          </section>

          <section data-auto-animate>
            <p>
              Using <span class="warn">Tanstack Query</span> for data fetching
            </p>

            <pre
              data-id="code2"
            ><code class="hljs tsx" data-trim data-line-numbers="9-10|1-6"><script type="text/template">
              
              const fetcher = async (uri: string): Promise => {
                const response = await fetch(uri);
                if (!response.ok) throw new Error('Could not fetch data!');

                return response.json();
              };

              function MyComponent() {
                const { data: user, isLoading, error } = useQuery(
                  ['user'],() => fetcher('/user'))
                
                return <p>{user?.name}</p>;
              }
            </script></code></pre>

            <p>
              <span class="warn">Clean & simple </span> &ndash; also comes with
              with retry, cache &amp; more functionality
            </p>
            <div class="fragment tip">In a future release, the loading state can be handled with Suspense</div>
          </section>
        </section>
        <section>
          <h3>Some words about types</h3>

          <pre
            data-id="code2"
          ><code class="hljs tsx" data-trim data-line-numbers="9,1,11-14"><script type="text/template">
            const fetcher = async <T>(uri: string): Promise<T> => {
              const response = await fetch(uri);
              if (!response.ok) throw new Error('Could not fetch data!');

              return response.json();
            };

            const { data: user } = useQuery(['user'], 
                () => fetcher<User>('/user'))

              interface User {
                firstName: string,
                /* ... */
              }
          </script></code></pre>

          <p>
            Since we are using TypeScript, we should always work with defined
            types&mdash;avoid <span class="code">any</span>!
          </p>
        </section>
        <section>
          <section data-auto-animate>
            <h2>Exercise</h2>

            <p><img src="../img/data_fetching_goal.png" height="100"/></p>
            <ul>
              <li>
                Retrieve the data for the pokemon list from the
                <a
                  href="https://pokeapi.co/"
                  target="_blank"
                  rel="noopener noreferrer"
                  >PokeAPI</a
                >.
              </li>
              <li>
                Install
                <a
                  href="https://tanstack.com/query"
                  target="_blank"
                  rel="noopener noreferrer"
                  >TanStack Query</a
                >: <span class="code">npm i @tanstack/react-query</span>
              </li>
              <li>
                API call with TanStack Query:
                <span class="code"
                  >GET https://pokeapi.co/api/v2/pokemon?limit=50</span
                >
              </li>
              <li>Stretch goal: Display loading & error messages
              </li>
            </ul>
          </section>
          <section data-auto-animate>
              <a
                href="https://tanstack.com/query"
                target="_blank"
                rel="noopener noreferrer"
                >TanStack Query</a
              >: <span class="code">npm i @tanstack/react-query</span></span
            >
            <pre>
              <code class="hljs json" data-trim data-noescape>
                export const fetcher = async <T>(uri: string): Promise<T> => {
                  const response = await fetch(uri);
                  if (!response.ok) throw new Error('Could not fetch data!');
                  return response.json();
                };
              </code>
          </pre>
            <a
              href="https://pokeapi.co/api/v2/pokemon?limit=5"
              target="_blank"
              rel="noopener noreferrer"
            >
              https://pokeapi.co/api/v2/pokemon?limit=5
            </a>
            <pre>
                <code class="hljs json" data-trim data-noescape>
                    {
                        ...
                        "results": [
                            {
                                "name": "bulbasaur",
                                "url": "https://pokeapi.co/api/v2/pokemon/1/"
                            },
                            ...
                        ]
                    }
                </code>
            </pre>
          </section>
        </section>
        <section>
          <section>
            <h2>Solution</h2>

            <p><span class="code">List.tsx</span></p>

            <pre><code class="hljs tsx" data-trim data-line-numbers="2-5|9-11|12|13"><script type="text/template">
            function List() {
              const {data: pokemons, isLoading, error} = 
                useQuery(["pokemon_list"], () =>
                fetcher<PokemonResultDto>("https://pokeapi.co/api/v2/pokemon?limit=1000")
              );

              return (
                <>
                  {!isLoading && !error && pokemons?.map((pokemon) => (
                    <PokeListEntry key={pokemon.name} name={pokemon.name} />
                  ))}
                  {isLoading && <div>LOADING</div>}
                  {error && <div>ERROR while loading data</div>}
                </>);
            }
        </script></code></pre>
          </section>
        </section>
        <section>
          <h2>Data Fetching Libraries</h2>

          <ul>
            <li>TanStack Query</li>
            <li>SWR</li>
            <li>Axios (for fetch abstraction)</li>
            <li>Apollo-Client (Graphql)</li>
          </ul>
          <p>More in-depth info will be in Chapter 11</p>
        </section>
        <section>
          <h2>Recap</h2>
          <p>We learned&hellip;</p>
          <ul>
            <li>Why fetching data is tricky with React render mechanism</li>
            <li>How to fetch data in React with a library</li>
            <li>Display details relating to loading & errors</li>
          </ul>
        </section>
        <section class="deck-slide">
          <h1>Questions?</h1>
        </section>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/webplatformz/zuehlke-reveal-package@aa0782bae9e270f4153d310e9f42bea172788e21/release/index.js"></script>
    <script>
      setupZuehlkeRevealPresentation();
    </script>
  </body>
</html>
