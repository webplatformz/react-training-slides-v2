<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>07 Data Fetching | Essential React</title>

    <link rel="icon" href="../img/zuehlke_logo.jpg" />
    <link rel="stylesheet" href="../dist/reset.css" />
    <link rel="stylesheet" href="../dist/reveal.css" />
    <link rel="stylesheet" href="../css/theme/zuehlke.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="../plugin/highlight/monokai.css" />
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        <section class="deck-slide">
          <h1>
            Essential React <br />
            07 Data Fetching
          </h1>
        </section>
        <section>
          <section>
            <p><img src="../img/data_fetching_goal.png" /></p>
            <p class="fragment">Where do we get this data from?</p>
          </section>
          <section>
            <h2>PokeAPI</h2>
            <a href="https://pokeapi.co/" target="_blank" rel="noopener noreferrer">
                Documentation
            </a>
        </section>
          <section>
            <h3>List of Pokemon</h3>
            <pre><code class="hljs json" data-trim data-line-numbers="|5-13"><script type="text/template">
                {
                  "count": 1118,
                  "next": "https://pokeapi.co/api/v2/pokemon?offset=5&limit=5",
                  "previous": null,
                  "results": [
                    {
                      "name": "bulbasaur",
                      "url": "https://pokeapi.co/api/v2/pokemon/1/"
                    },
                    {
                      "name": "ivysaur",
                      "url":"https://pokeapi.co/api/v2/pokemon/2/"
                    },
                    …
                  ]
                }
              </script></code></pre>
        <p>
          <a
            href="https://pokeapi.co/api/v2/pokemon?limit=5"
            target="_blank"
            rel="noopener noreferrer"
          >
            GET https://pokeapi.co/api/v2/pokemon?limit=5
          </a>
        </p>
          </section>
        </section>
        <section>
          <section><h2>What to use for data fetching?</h2></section>
          <section>
            <ul>
              <li>React does <em>not</em> provide data fetching</li>
              <li><span class="warn">Fetch:</span> standard browser API</li>
              <li>&hellip; or any data fetching library</li>
            </ul>
          </section>
          <section>
            <h3>Fetch</h3>
            <pre><code class="hljs typescript" data-trim data-line-numbers="1-4|6-9|11-12|"><script type="text/template">
                // Send the request and wait for the response
                const response = await fetch(
                  'https://example.com/data'
                );

                // Did we get a response status code other than 2XX?
                if (!response.ok) {
                  throw new Error("Could not fetch data!");
                }

                // Deserialize the JSON response body
                const data = await response.json();
              </script></code></pre>
          </section>
        </section>
        <section>
          <section><h2>How do we use fetch in React?</h2></section>
          <section>
            <p>Does this work?</p>
            <pre><code class="hljs tsx" data-trim data-line-numbers="|2,5"><script type="text/template">
               function MyComponent() {
                 const response = await fetch('/user');
                 if (!response.ok) throw new Error('Could not fetch data!');   

                 const user = await response.json();   
                 
                 return <p>{user.name}</p>;
               }        
              </script></code></pre>
            <p class="fragment">
              <span class="warn">Does not work!</span> &ndash; The render
              function is not async.
            </p>
          </section>
          <section>
            <p>Well, how about this?</p>
            <pre><code class="hljs tsx" data-trim data-line-numbers="|4,7|2,8,12"><script type="text/template">
               function MyComponent() {
                 let user;

                 fetch('/user').then(response => {
                   if (!response.ok) throw new Error('Could not fetch data!');

                   response.json().then(u => {
                     user = u;
                   });
                 });   
                 
                 return <p>{user?.name}</p>;
               }</script></code></pre>
            <p class="fragment">
              <span class="warn">Does not work!</span> &ndash; When the promise
              resolves, the render function already ran.
            </p>
          </section>
          <section>
              <p>Fetching data asynchronously requires state management.</p>
              <p><span class="warn">&rarr;useState</span></p>
          </section>
          <section>
            <pre><code class="hljs tsx" data-trim data-line-numbers="|4,7|2,8,12"><script type="text/template">
              function MyComponent() {
                const [user, setUser] = useState();

                fetch('/user').then(response => {
                  if (!response.ok) throw new Error('Could not fetch data!');

                  response.json().then(u => {
                    setUser(u);
                  });
                });   
                
                return <p>{user?.name}</p>;
              }</script></code></pre>
              <p class="fragment">
                <span class="warn">Bad!</span> &ndash; This produces an infinte loop.
              </p>
          </section>
          <section>
            <h3>Why we should <em>not</em> run side effects in the render function</h3>
            <ul>
              <li class="fragment">We don't want the side effect to execute with every render.</li>
              <li class="fragment">The render function might be executed anytime &ndash; we don't control it.</li>
              <li class="fragment">In the render function we just want to render and not spend computing on other tasks.</li>
            </ul>
          </section>
          <section data-auto-animate>
            <h3>The <span class="warn">useEffect</span> Hook</h3>
            <pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="1,5-9"><script type="text/template">
                 import { useEffect } from "react";

                 function MyComponent() {

                   useEffect(() => {

                     // Run side effect

                   }, [dependency1, dependency2]);

                   // …
                 }
                  </script></code></pre>
          </section>
          <section data-auto-animate>
            <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="|5"><script type="text/template">
              
                   useEffect(() => {

                     // Run side effect

                   }, [dependency1, dependency2]);
                  </script></code></pre></p>
              <p>The effect is executed initially and whenever a dependency changes.</p>
          </section>
          <section data-auto-animate>
            <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="5"><script type="text/template">
              
                   useEffect(() => {

                     // Run side effect

                   }, []);
                  </script></code></pre></p>
              <p>When passing an empty array, the effect is executed only initially (on first render).</p>
          </section>
          <section data-auto-animate>
            <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="5"><script type="text/template">
              
                   useEffect(() => {

                     // Run side effect

                   });
                  </script></code></pre></p>
              <p>If no depencencies are passed, the effect is executed with every render.</p>
          </section>
          <section data-auto-animate>
            <p>Let's call this API correctly!</p>
            <p><pre data-id="code2"><code class="hljs tsx" data-trim data-line-numbers="|4-12|12|"><script type="text/template">
              function MyComponent() {
                const [user, setUser] = useState();

                useEffect(() => {
                  fetch('/user').then(response => {
                    if (!response.ok) throw new Error('Could not fetch data!');
  
                    response.json().then(u => {
                      setUser(u);
                    });
                  }); 
                }, []);
                
                return <p>{user?.name}</p>;
              }
            </script></code></pre></p>

              <p class="fragment"><em>Wait&hellip;</em> but what about <span class="warn">async-await?</span></p>
          </section>
          <section data-auto-animate>
            <p>What about <span class="warn">async-await?</span></p>

            <p><pre data-id="code2"><code class="hljs tsx" data-trim data-line-numbers="|3,6"><script type="text/template">
                useEffect(() => {

                  fetch('/user').then(response => {
                    if (!response.ok) throw new Error('Could not fetch data!');
  
                    response.json().then(u => {
                      setUser(u);
                    });
                  }); 

                }, []);
            </script></code></pre></p>
          </section>
          <section data-auto-animate>
            <p>What about <span class="warn">async-await?</span></p>

            <p><pre data-id="code2"><code class="hljs tsx" data-trim data-line-numbers="3,6"><script type="text/template">
                useEffect(() => {

                  const response = await fetch('/user');
                  if (!response.ok) throw new Error('Could not fetch data!');

                  const user = await response.json();
                  setUser(user);

                }, []);
            </script></code></pre></p>
          </section>
          <section data-auto-animate>
            <p>What about <span class="warn">async-await?</span></p>

            <p><pre data-id="code2"><code class="hljs tsx" data-trim data-line-numbers="1"><script type="text/template">
                useEffect(() => {

                  const response = await fetch('/user');
                  if (!response.ok) throw new Error('Could not fetch data!');

                  const user = await response.json();
                  setUser(user);

                }, []);
            </script></code></pre></p>

            <p><span class="warn">Does not work!</span> &ndash; The effect function is not async.</p>
          </section>
          <section data-auto-animate>
            <p>What about <span class="warn">async-await?</span></p>

            <p><pre data-id="code2"><code class="hljs tsx" data-trim data-line-numbers="1"><script type="text/template">
                useEffect(async () => {

                  const response = await fetch('/user');
                  if (!response.ok) throw new Error('Could not fetch data!');

                  const user = await response.json();
                  setUser(user);

                }, []);
            </script></code></pre></p>

            <p><span class="warn">Does not work!</span> &ndash; The effect function is not async.</p>
          </section>
          <section data-auto-animate>
            <p>What about <span class="warn">async-await?</span></p>

            <p><pre data-id="code2"><code class="hljs tsx" data-trim data-line-numbers="1,3,9|"><script type="text/template">
                useEffect(() => {

                  (async function() {
                    const response = await fetch('/user');
                    if (!response.ok) throw new Error('Could not fetch data!');
  
                    const user = await response.json();
                    setUser(user);
                  })();

                }, []);
            </script></code></pre></p>

            <p><span class="warn">This works!</span> &ndash; We call our async logic without waiting for its top-level promise to resolve.</p>
          </section>
        </section>
        <section>
          <section>
            <h2>Exercise</h2>

            <p><img src="../img/data_fetching_goal.png" /></p>
            <ul>
              <li>Retrieve the data for the pokemon list from the <a href="https://pokeapi.co/" target="_blank" rel="noopener noreferrer">PokeAPI</a>.</li>
              <li>API call: <span class="code">GET https://pokeapi.co/api/v2/pokemon?limit=50</li>
            </ul>
          </section>
          <section>
            <h2>List API</h2>
            <a href="https://pokeapi.co/api/v2/pokemon?limit=5" target="_blank" rel="noopener noreferrer">
                https://pokeapi.co/api/v2/pokemon?limit=5
            </a>
            <pre>
                <code class="hljs json" data-trim data-noescape>
                    {
                        "count": 1118,
                        "next": "https://pokeapi.co/api/v2/pokemon?offset=5&limit=5",
                        "previous": null,
                        "results": [
                            {
                                "name": "bulbasaur",
                                "url": "https://pokeapi.co/api/v2/pokemon/1/"
                            },
                            ...
                        ]
                    }
                </code>
            </pre>
          </section>
        </section>
        <section>
          <h2>Solution</h2>

          <p><span class="code">List.tsx</span></p>

          <p><pre><code class="hljs tsx" data-trim data-line-numbers="|2-9"><script type="text/template">
            function List() {
              const [pokemons, setPokemons] = useState(null);
              useEffect(() => {
                (async () => {
                  const response = await fetch("https://pokeapi.co/api/v2/pokemon?limit=50");
                  const pokemons = await response.json();
                  setPokemons(pokemons.results);
                })();
              }, []);

              return (<>
                {pokemons?.map((pokemon) => (
                  <PokeListEntry key={pokemon.name} name={pokemon.name} />
                ))}
              </>);
            }
        </script></code></pre></p>
        </section>
        <section>
          <section><h2>Custom Hooks</h2></section>
          <section>
            <p>We can reuse a concrete Hook logic by extracting it into a <span class="warn">custom Hook</span>.</p>
          </section>
          <section data-auto-animate>

            <p><span class="code">MyComponent.tsx</span></p>

            <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="|4-14|3,16-17"><script type="text/template">
              import { useState, useEffect } from "react";

              export default function MyComponent() {
                const [user, setUser] = useState();

                useEffect(() => {
                  (async function() {
                    const response = await fetch('/user');
                    if (!response.ok) throw new Error('Could not fetch data!');

                    const user = await response.json();
                    setUser(user);
                  })();
                }, []);

                // …
              }
            
          </script></code></pre></p>
          </section>
          <section data-auto-animate>

            <p>&rarr; <span class="code">useUser.ts</span></p>

            <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="3,16-17|"><script type="text/template">
              import { useState, useEffect } from "react";

              export default function useUser() {
                const [user, setUser] = useState();

                useEffect(() => {
                  (async function() {
                    const response = await fetch('/user');
                    if (!response.ok) throw new Error('Could not fetch data!');

                    const user = await response.json();
                    setUser(user);
                  })();
                }, []);

                return user;
              }
            
          </script></code></pre></p>
          </section>
          <section data-auto-animate>

            <p data-id="2"><span class="code">MyComponent.tsx</span></p>

            <p><pre data-id="code2"><code class="hljs tsx" data-trim data-line-numbers="|1,4-14"><script type="text/template">
              import { useState, useEffect } from "react";

              export default function MyComponent() {
                const [user, setUser] = useState();

                useEffect(() => {
                  (async function() {
                    const response = await fetch('/user');
                    if (!response.ok) throw new Error('Could not fetch data!');

                    const user = await response.json();
                    setUser(user);
                  })();
                }, []);

                // …
              }
            
          </script></code></pre></p>
          </section>
          <section data-auto-animate>

            <p data-id="2"><span class="code">MyComponent.tsx</span></p>

            <p><pre data-id="code2"><code class="hljs tsx" data-trim data-line-numbers="1,4|"><script type="text/template">
              import useUser from "./useUser.ts";

              export default function MyComponent() {
                const user = useUser();

                // …
              }
            
          </script></code></pre></p>
          </section>
        </section>
        <section>
          <h2>Exercise</h2>

          <p>Extract the data fetching logic for loading the list of pokemon into a custom Hook.</p>
          
          <div class="column-container">
            <div class="column"><img src="../img/construction_work_refactor.jpg" /></div>
          </div>
        </section>
        <section>
          <section>
          <h2>Solution</h2>
        </section>
        <section>
          <p><span class="code">usePokeList.ts</span></p>
          
          <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="3,12-15"><script type="text/template">
import { useEffect, useState } from "react";

function usePokeList() {
  const [pokemons, setPokemons] = useState(null);
  useEffect(() => {
    (async () => {
      const res = await fetch("https://pokeapi.co/api/v2/pokemon?limit=50");
      const pokemons = await res.json();
      setPokemons(pokemons.results);
    })();
  }, []);
  return pokemons;
}

export default usePokeList;
</script></code></pre></p>
</section>
<section>

  <p><span class="code">List.tsx</span></p>
          
  <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="3,6"><script type="text/template">
    import DefaultLayout from "../../components/default-layout/DefaultLayout";
    import PokeListEntry from "../../components/poke-list-entry/PokeListEntry";
    import usePokeList from "../../service/poke/usePokeList";
    
    function List() {
      const pokemons = usePokeList();
      return (
        <>
          {pokemons?.map((pokemon) => (
            <PokeListEntry key={pokemon.name} name={pokemon.name} />
          ))}
        </>
      );
    }
    
    export default List;
    
</script></code></pre></p>
</section>
        </section>
        <section>
          <section>
          <h2>useEffect Cleanup</h2>
        </section>
        <section>
          <p>Some side effects may require a <span class="warn">cleanup</span> logic to be executed when the component is unmounted.</p>

        </section>
        <section>
          <h3>Examples</h3>
          <ul>
            <li>Cancelling a network request/asynchronous operation</li>
            <li>Unsubscribing from a pub-sub interface</li>
            <li>Releasing resources to prevent a memory leak</li>
          </ul>
      </section>
      <section data-auto-animate>

        <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers=""><script type="text/template">
        useEffect(() => {

          // Do something which requires a cleanup
          // when the component is unmounted

        }, []);
      </script></code></pre></p>

      <p>How do we perform the cleanup?</p>
      </section>
      <section data-auto-animate>

        <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="6-8|"><script type="text/template">
        useEffect(() => {

          // Do something which requires a cleanup
          // when the component is unmounted

          return () => {
            // Perform the cleanup
          };
        }, []);
      </script></code></pre></p>
      </section>
        </section>
        <section>
          <section data-auto-animate>
          <h2>Exercise</h2>
          <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="6-7|8"><script type="text/template">
function usePokeList() {
  const [pokemons, setPokemons] = useState(null);

  useEffect(() => {
    (async () => {
      const response = await fetch("https://pokeapi.co/api/v2/pokemon?limit=50");
      const pokemons = await response.json();
      setPokemons(pokemons.results);
    })();
  }, []);

  return pokemons;
}
</script></code></pre></p>

          <p>What happens if the component is unmounted while the request or deserialization is still running?</p>
        </section>

        <section data-auto-animate>
          <h2>Exercise</h2>
          <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="8"><script type="text/template">
function usePokeList() {
  const [pokemons, setPokemons] = useState(null);

  useEffect(() => {
    (async () => {
      const response = await fetch("https://pokeapi.co/api/v2/pokemon?limit=50");
      const pokemons = await response.json();
      setPokemons(pokemons.results);
    })();
  }, []);

  return pokemons;
}
</script></code></pre></p>

<p><img src="../img/state_update_on_unmounted_warning.png"></p>
        </section>
        <section data-automate>
          <p><img src="../img/state_update_on_unmounted_warning.png"></p>
          <p>&rarr; State updates on unmounted components will result in this warning.</p>
        </section>
        <section>
          <ul>
            <li>Prevent the state update if the component was unmounted during the asynchronous operation.</li>
            <li class="fragment">Stretch goal: Make it possile to test this manually.
              <ul>
                <li class="fragment">Hint: Add/remove the List component to/from the DOM upon a button click.</li>
                <li class="fragment">Hint: Use a delay to make it easier to test.</li>
              </ul>
            </li>
          </ul>
          <span class="code fragment">
            await new Promise((resolve) => setTimeout(resolve, 3000));
          </span>
        </section>
        </section>
        <section>
          <h2>Solution</h2>
          <p><span class="code">usePokeList.ts</span></p>
          
          <p><pre data-id="code"><code class="hljs tsx" data-trim data-line-numbers="5,10,12|"><script type="text/template">
function usePokeList() {
  const [pokemons, setPokemons] = useState(null);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      const response = await fetch("https://pokeapi.co/api/v2/pokemon?limit=50");
      const pokemons = await response.json();

      if (!cancelled) setPokemons(pokemons.results);
    })();
    return () => { cancelled = true; };
  }, []);

  return pokemons;
}
</script></code></pre></p>
</section>
<section>
  <h2>Data Fetching Libraries</h2>

  <ul>
    <li>Axios</li>
    <li>React Query</li>
    <li>SWR</li>
    <li>&hellip;</li>
  </ul>
</section>
<section>
  <h2>Recap</h2>
  <p>We learned&hellip;</p>
  <ul>
    <li>Options for data fetching in React</li>
    <li>How to perform side effects with the <span class="warn">useEffect</span> Hook</li>
    <li>How to extract and reuse stateful logic and side effects with <span class="warn">custom Hooks</span></li>
    <li>How to cleanup side effects in useEffect</li>
  </ul>
</section>
        <section class="deck-slide">
            <h1>Questions?</h1>
        </section>
      </div>
    </div>

    <script src="../dist/reveal.js"></script>
    <script src="../plugin/notes/notes.js"></script>
    <script src="../plugin/markdown/markdown.js"></script>
    <script src="../plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });
    </script>
  </body>
</html>
